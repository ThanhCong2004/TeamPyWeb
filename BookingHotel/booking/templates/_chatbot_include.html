<!-- Nút bấm để mở chat -->
<button class="chat-fab" id="chat-fab-button" title="Tư vấn với AI">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.5A4.5 4.5 0 0 0 18 5.5c0 2.71-2.01 4.94-4.5 4.94-2.05 0-3.83-1.16-4.5-2.62-.27-.58-.5-1.2-.5-1.88A4.5 4.5 0 0 0 4 9.5c0 4.5 3 12.5 6 12.5 1.25 0 2.5-1.06 4-1.06Z"/><path d="M12 2v2"/><path d="M5 5l1.4-1.4"/><path d="M19 5l-1.4-1.4"/></svg>
</button>

<!-- Cửa sổ chat -->
<div class="chat-popup" id="chat-popup-window">
    <div class="chat-header">
        <h4>Trợ lý AI</h4>
        <button id="close-chat-button">×</button>
    </div>
    <div class="chat-messages" id="chat-messages-container">
        <!-- Tin nhắn chào mừng -->
        <div class="message ai-message">
            <p>Xin chào! Tôi có thể giúp gì cho bạn trong việc tìm kiếm khách sạn?</p>
        </div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chat-input-field" placeholder="Nhập câu hỏi của bạn...">
        <button id="send-chat-button">Gửi</button>
    </div>
</div>

<style>
    .chat-fab {
        position: fixed;
        bottom: 25px;
        right: 25px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #007bff;
        color: white;
        border: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: transform 0.2s ease-in-out;
    }
    .chat-fab:hover {
        transform: scale(1.1);
    }
    .chat-popup {
        position: fixed;
        bottom: 95px;
        right: 25px;
        width: 350px;
        max-width: 90vw;
        height: 500px;
        max-height: 70vh;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 1001;
        display: none;
        flex-direction: column;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .chat-popup.active {
        display: flex;
        opacity: 1;
        transform: translateY(0);
    }
    .chat-header {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .chat-header h4 { margin: 0; font-weight: 500; }
    .chat-header button { background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1; }
    .chat-messages {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background-color: #f9f9f9;
    }
    .message {
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 80%;
        line-height: 1.4;
    }
    .user-message {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 3px;
    }
    .ai-message {
        background-color: #e9ecef;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 3px;
    }
    .ai-message p { margin: 0; }
    .ai-message strong { color: #0056b3; }
    .loading-indicator {
        align-self: flex-start;
    }
    .loading-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #999;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    .loading-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .loading-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }
    .chat-input-area {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ccc;
        background-color: #fff;
    }
    #chat-input-field {
        flex-grow: 1;
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 8px 15px;
        margin-right: 10px;
        outline: none;
        transition: border-color 0.2s;
    }
    #chat-input-field:focus {
        border-color: #007bff;
    }
    #send-chat-button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }
    #send-chat-button:hover {
        background-color: #0056b3;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const chatFab = document.getElementById('chat-fab-button');
    const chatPopup = document.getElementById('chat-popup-window');
    const closeChat = document.getElementById('close-chat-button');
    const sendButton = document.getElementById('send-chat-button');
    const inputField = document.getElementById('chat-input-field');
    const messagesContainer = document.getElementById('chat-messages-container');
    const chatApiUrl = '{% url "gemini_chat_api" %}'; // Lấy URL từ Django template

    // Thêm icon gửi cho button
    sendButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;

    // Mở/đóng cửa sổ chat
    chatFab.addEventListener('click', () => chatPopup.classList.toggle('active'));
    closeChat.addEventListener('click', () => chatPopup.classList.remove('active'));

    // Hàm gửi tin nhắn
    const sendMessage = async () => {
        const messageText = inputField.value.trim();
        if (!messageText) return;

        appendMessage(messageText, 'user-message');
        inputField.value = '';
        inputField.focus();

        const loadingIndicator = showLoading();

        try {
            const response = await fetch(chatApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Nếu bạn dùng CSRF token, hãy bỏ comment dòng dưới.
                    // Với @csrf_exempt ở view thì không cần.
                    // 'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ message: messageText }),
            });

            removeLoading(loadingIndicator);

            if (!response.ok) {
                const errorData = await response.json();
                appendMessage(`Lỗi: ${errorData.error || 'Không thể kết nối'}.`, 'ai-message');
                return;
            }

            const data = await response.json();
            const formattedReply = data.reply.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            appendMessage(formattedReply, 'ai-message', true);

        } catch (error) {
            removeLoading(loadingIndicator);
            appendMessage('Đã có lỗi xảy ra khi kết nối tới trợ lý AI.', 'ai-message');
            console.error('Chat Error:', error);
        }
    };

    inputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    sendButton.addEventListener('click', sendMessage);

    function appendMessage(text, className, isHtml = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', className);
        const p = document.createElement('p');
        if (isHtml) {
            p.innerHTML = text;
        } else {
            p.textContent = text;
        }
        messageDiv.appendChild(p);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showLoading() {
        const loadingDiv = document.createElement('div');
        loadingDiv.classList.add('message', 'loading-indicator');
        loadingDiv.innerHTML = '<span></span><span></span><span></span>';
        messagesContainer.appendChild(loadingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return loadingDiv;
    }

    function removeLoading(indicator) {
        if (indicator) {
            messagesContainer.removeChild(indicator);
        }
    }
});
</script>